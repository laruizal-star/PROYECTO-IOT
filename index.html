<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Panel IoT - Blynk</title>
  <style>
    body { font-family: Arial; background: #f5f5f5; padding: 20px; }
    .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 0 10px #aaa3; }
    .switch { width: 60px; height: 30px; background: #ccc; border-radius: 30px; position: relative; cursor: pointer; }
    .circle { width: 26px; height: 26px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.2s; }
    .on { background: #4caf50; }
    .on .circle { left: 32px; }

    /* üî• Nuevo: estilo de bloqueo */
    .disabled {
      opacity: 0.4;
      cursor: not-allowed !important;
      pointer-events: none;
    }
  </style>
</head>

<body>

  <h1>CONTROL DE INVERNADERO - IOT CON HTTP</h1>

  <div class="card">
    <h2>Temperatura: <span id="temp">--</span> ¬∞C</h2>
    <h2>Humedad ambiente: <span id="hum">--</span> %</h2>
    <h2>Humedad del suelo: <span id="soil">--</span></h2>
  </div>

  <div class="card">
    <h2>Ventilador</h2>
    <div id="toggleFan" class="switch" onclick="toggleFan()">
      <div class="circle"></div>
    </div>
  </div>
  
  <div class="card">
    <h2>Modo de riego</h2>
    <h3><span id="modeText">MANUAL</span></h3>
    <div id="toggleMode" class="switch" onclick="toggleMode()">
      <div class="circle"></div>
    </div>
  </div>

  <div class="card">
    <h2>Activar bomba de agua <br><small>(Disponible solo en modo manual)</small></h2>
    <div id="togglePump" class="switch" onclick="togglePump()">
      <div class="circle"></div>
    </div>
  </div>

<script>

const TOKEN = "FyZnCNggIQ91xPA6a_FPfExvB-hcwfn0"; 
const BASE = "https://blynk.cloud/external/api";

let modoActual = 0; // guardamos el modo localmente

// ---- Leer datos ----
function readData() {
  fetch(`${BASE}/get?token=${TOKEN}&V0`).then(r=>r.json()).then(data => document.getElementById("temp").innerText = data);
  fetch(`${BASE}/get?token=${TOKEN}&V1`).then(r=>r.json()).then(data => document.getElementById("hum").innerText = data);
  
  fetch(`${BASE}/get?token=${TOKEN}&V3`).then(r=>r.json()).then(data => {
    document.getElementById("soil").innerText = data == 0 ? "H√öMEDO" : "SECO";
  });

  // ---- Leer modo (V5) ----
  fetch(`${BASE}/get?token=${TOKEN}&V5`).then(r=>r.json()).then(data => {
    modoActual = data;
    let mode = document.getElementById("toggleMode");
    document.getElementById("modeText").innerText = data == 1 ? "AUTOM√ÅTICO" : "MANUAL";
    if(data == 1) mode.classList.add("on");
    else mode.classList.remove("on");

    // üî• Habilitar / deshabilitar el bot√≥n de la bomba seg√∫n modo
    let pumpBtn = document.getElementById("togglePump");
    if(data == 1) pumpBtn.classList.add("disabled");
    else pumpBtn.classList.remove("disabled");
  });

  // ---- Leer estado real de la bomba
